<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiModal Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .chat-box-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .chat-box-container::-webkit-scrollbar { width: 8px; }
        .chat-box-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        .chat-box-container::-webkit-scrollbar-track { background-color: #1f2937; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple icon components
        const SendIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const ImageIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        );

        const TerminalIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
        );

        const LoaderIcon = () => (
            <svg className="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
        );

        const AlertIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const CopyIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const CheckIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const copyToClipboard = (text) => {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        };

        const BotMessage = ({ content, type, onCopy, isCopied, id }) => {
            const renderContent = () => {
                switch (type) {
                    case 'text':
                        return <div className="text-gray-200 whitespace-pre-wrap">{content}</div>;
                    case 'command':
                        return (
                            <div className="bg-gray-800 p-3 rounded-lg flex justify-between items-start space-x-3">
                                <div className="text-green-400 mt-1 flex-shrink-0"><TerminalIcon /></div>
                                <pre className="flex-1 overflow-x-auto text-sm text-green-300 font-mono whitespace-pre-wrap break-all">{content}</pre>
                                <button
                                    onClick={onCopy}
                                    className="p-1 text-gray-400 hover:text-white transition-colors flex items-center gap-1 text-xs font-medium"
                                >
                                    {isCopied ? <CheckIcon /> : <CopyIcon />}
                                    {isCopied ? 'Copied' : 'Copy'}
                                </button>
                            </div>
                        );
                    case 'image_data':
                        return (
                            <div className="flex flex-col items-center gap-4">
                                <p className="text-sm text-gray-400 flex items-center gap-2">
                                    <ImageIcon /> Generated Image
                                </p>
                                <img
                                    src={`data:image/png;base64,${content}`}
                                    alt="Generated by AI"
                                    className="max-w-full h-auto rounded-lg shadow-xl"
                                />
                            </div>
                        );
                    case 'error':
                        return (
                            <div className="bg-red-900/30 p-3 rounded-lg border border-red-700 text-red-300 flex items-start gap-2">
                                <div className="flex-shrink-0 mt-1"><AlertIcon /></div>
                                <p className="font-semibold">Error: <span className="font-normal">{content}</span></p>
                            </div>
                        );
                    default:
                        return <div className="text-gray-200">{content}</div>;
                }
            };

            const icon = type === 'text' ? 'ü§ñ' : (type === 'command' ? 'üíª' : (type === 'image_data' ? 'üñºÔ∏è' : 'üö®'));

            return (
                <div className="flex items-start gap-3 p-4 bg-gray-800/50 rounded-lg shadow-md mb-4">
                    <div className="text-xl flex-shrink-0">{icon}</div>
                    <div className="flex-1 min-w-0">
                        {renderContent()}
                    </div>
                </div>
            );
        };

        const UserMessage = ({ content }) => (
            <div className="flex items-start justify-end gap-3 p-4 bg-blue-600/50 rounded-lg shadow-md mb-4 ml-auto max-w-[80%]">
                <div className="flex-1 min-w-0">
                    <div className="text-gray-50">{content}</div>
                </div>
                <div className="text-xl flex-shrink-0">üë§</div>
            </div>
        );

        const MultiModalOrchestrator = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [ws, setWs] = useState(null);
            const [error, setError] = useState(null);
            const [copiedMessageId, setCopiedMessageId] = useState(null);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                if (copiedMessageId) {
                    const timer = setTimeout(() => setCopiedMessageId(null), 2000);
                    return () => clearTimeout(timer);
                }
            }, [copiedMessageId]);

            useEffect(() => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const url = `${protocol}//${host}:8765/ws`;

                console.log('Connecting to WebSocket:', url);
                const newWs = new WebSocket(url);

                newWs.onopen = () => {
                    console.log('WebSocket connected');
                    setError(null);
                    setLoading(false);
                    newWs.send(JSON.stringify({ type: 'get_history' }));
                };

                newWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Received:', data);

                        if (data.type === 'history') {
                            const history = data.messages.map(msg => ({
                                id: crypto.randomUUID(),
                                ...msg,
                                role: msg.role === 'user' ? 'user' : 'assistant'
                            }));
                            setMessages(history);
                            setLoading(false);
                        } else if (data.type === 'response') {
                            setMessages(prev => [
                                ...prev,
                                {
                                    id: crypto.randomUUID(),
                                    role: 'assistant',
                                    content: data.content,
                                    message_type: data.message_type || 'text'
                                }
                            ]);
                            setLoading(false);
                        } else if (data.type === 'error') {
                            setMessages(prev => [
                                ...prev,
                                {
                                    id: crypto.randomUUID(),
                                    role: 'assistant',
                                    content: data.content,
                                    message_type: 'error'
                                }
                            ]);
                            setLoading(false);
                        } else if (data.type === 'loading') {
                            setLoading(data.content === 'start');
                        }
                    } catch (e) {
                        console.error("Error parsing WebSocket message:", e);
                        setError("Received malformed data from the server.");
                    }
                };

                newWs.onclose = (e) => {
                    console.log('WebSocket disconnected', e);
                    setLoading(false);
                    setError('Connection lost. Attempting to reconnect...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                };

                newWs.onerror = (err) => {
                    console.error('WebSocket error:', err);
                };

                setWs(newWs);

                return () => {
                    if (newWs) newWs.close();
                };
            }, []);

            const sendMessage = () => {
                if (!input.trim() || loading || !ws || ws.readyState !== WebSocket.OPEN) return;

                const message = input.trim();
                setLoading(true);
                setInput('');

                setMessages(prev => [
                    ...prev,
                    {
                        id: crypto.randomUUID(),
                        role: 'user',
                        content: message,
                        message_type: 'text'
                    }
                ]);

                ws.send(JSON.stringify({ type: 'message', content: message }));
            };

            const handleCopy = (id, content) => {
                copyToClipboard(content);
                setCopiedMessageId(id);
            };

            return (
                <div className="flex flex-col h-screen antialiased">
                    <header className="flex items-center justify-between p-4 bg-gray-900 border-b border-gray-700 shadow-lg">
                        <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                            <ImageIcon />
                            MultiModal Orchestrator
                        </h1>
                        <p className="text-sm text-gray-400">AI Assistant</p>
                    </header>

                    <main className="flex-1 p-4 overflow-hidden">
                        <div className="max-w-4xl mx-auto h-full flex flex-col">
                            {error && (
                                <div className="p-4 bg-red-500 text-white rounded-lg mb-4 flex items-center gap-2">
                                    <AlertIcon />
                                    {error}
                                </div>
                            )}

                            <div className="chat-box-container flex-1 mb-4 p-4 bg-gray-900/50 rounded-xl border border-gray-700 shadow-inner">
                                {messages.length === 0 && !loading && (
                                    <div className="flex items-center justify-center h-full text-gray-500">
                                        <p>Start a conversation...</p>
                                    </div>
                                )}
                                {messages.map((msg) =>
                                    msg.role === 'user' ? (
                                        <UserMessage key={msg.id} content={msg.content} />
                                    ) : (
                                        <BotMessage
                                            key={msg.id}
                                            id={msg.id}
                                            content={msg.content}
                                            type={msg.message_type}
                                            onCopy={() => handleCopy(msg.id, msg.content)}
                                            isCopied={copiedMessageId === msg.id}
                                        />
                                    )
                                )}
                                {loading && (
                                    <div className="flex items-center justify-center p-4">
                                        <LoaderIcon />
                                        <span className="ml-2 text-gray-400">Thinking...</span>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="flex gap-3">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            sendMessage();
                                        }
                                    }}
                                    rows="1"
                                    placeholder="Type your message or request an image..."
                                    className="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 resize-none text-white"
                                    disabled={loading}
                                    style={{maxHeight: '150px'}}
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={loading || !input.trim() || ws?.readyState !== WebSocket.OPEN}
                                    className="px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center justify-center gap-2 font-semibold text-white shadow-md"
                                >
                                    {loading ? <LoaderIcon /> : <SendIcon />}
                                    <span className="hidden sm:inline">{loading ? 'Processing' : 'Send'}</span>
                                </button>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MultiModalOrchestrator />);
    </script>
</body>
</html>